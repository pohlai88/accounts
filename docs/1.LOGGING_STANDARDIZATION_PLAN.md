# AI-BOS Logging Standardization Development Plan

## Executive Summary

**Problem**: The codebase has 6,141+ inconsistent console.log statements across 240+ files, multiple competing logging systems, and build-breaking malformed logs.

**Solution**: Implement a hybrid optimization approach that standardizes logging without removing observability, providing a unified MVP logging layer that's production-ready and future-proof.

**Decision**: ✅ **HYBRID OPTIMIZE** - Standardize, don't delete

---

## Current State Analysis

### Critical Issues Identified

1. **Volume**: 6,141+ console.log statements across 240+ files
2. **Inconsistency**: Multiple competing logging systems:
   - `@aibos/monitoring` (custom Logger class)
   - `@aibos/utils` (Winston-based)
   - Raw `console.*` everywhere
3. **Patterns**: Inconsistent approaches:
   - Some wrapped in `process.env.NODE_ENV === 'development'`
   - Some with `eslint-disable-next-line no-console`
   - Some completely unprotected
4. **Build Issues**: Malformed template literals causing compilation failures
5. **No Context**: Missing request correlation, tenant IDs, user IDs
6. **No Structure**: Unstructured logs difficult to search and analyze

### Impact Assessment

| Issue          | Severity | Impact                |
| -------------- | -------- | --------------------- |
| Build Failures | Critical | Blocks deployments    |
| Log Noise      | High     | Difficult debugging   |
| No Correlation | High     | Cannot trace requests |
| Security Risk  | Medium   | Potential data leaks  |
| Performance    | Medium   | Console overhead      |

---

## Proposed Solution Architecture

### Core Components

1. **Unified Logger Package** (`@aibos/logger`)
   - Pino-based (fast, JSON, production-ready)
   - Automatic secret redaction
   - Structured logging with consistent fields
   - Environment-aware (pretty dev, JSON prod)

2. **Request Context System** (`@aibos/utils/context`)
   - AsyncLocalStorage for request correlation
   - Automatic context binding to logs
   - Multi-tenant support

3. **ESLint Rules**
   - Forbid `console.*` usage
   - Require `@aibos/logger`
   - Enforce structured logging patterns

4. **Migration Strategy**
   - Gradual replacement of console statements
   - Priority-based migration (critical paths first)
   - Backward compatibility during transition

---

## Implementation Phases

### Phase 1: Foundation (1-2 days)

**Priority**: P0 - Fix build-breaking issues

**Deliverables**:

- [ ] Create `@aibos/logger` package with Pino
- [ ] Implement request context system
- [ ] Add ESLint rules
- [ ] Fix malformed logs causing build failures
- [ ] Create migration guide

**Success Criteria**:

- Build passes without errors
- New logger package available
- ESLint rules prevent new console usage

### Phase 2: Critical Path Migration (2-3 days)

**Priority**: P1 - High-impact areas

**Deliverables**:

- [ ] Migrate API routes (`apps/web-api/app/api/*`)
- [ ] Migrate monitoring package
- [ ] Migrate error handling
- [ ] Add request middleware

**Success Criteria**:

- All API routes use structured logging
- Request correlation working
- Error tracking improved

### Phase 3: UI Components (1-2 days)

**Priority**: P2 - User-facing components

**Deliverables**:

- [ ] Migrate React components
- [ ] Add client-side logging
- [ ] Implement error boundaries with logging

**Success Criteria**:

- UI components use structured logging
- Client-side errors tracked
- User experience improved

### Phase 4: Background Services (1 day)

**Priority**: P3 - Worker processes

**Deliverables**:

- [ ] Migrate worker services
- [ ] Add job correlation
- [ ] Implement batch logging

**Success Criteria**:

- Background jobs logged consistently
- Job tracking improved

### Phase 5: Production Integration (1-2 days)

**Priority**: P4 - Observability platform

**Deliverables**:

- [ ] Configure log aggregation (Grafana Loki/Datadog)
- [ ] Set up log retention policies
- [ ] Implement log sampling
- [ ] Add monitoring dashboards

**Success Criteria**:

- Logs aggregated in production
- Dashboards operational
- Alerting configured

---

## Technical Specifications

### Logger Package Structure

```
packages/logger/
├── package.json
├── src/
│   ├── index.ts          # Core logger
│   ├── bind.ts          # Context binding
│   ├── redaction.ts     # Secret redaction
│   └── types.ts         # TypeScript definitions
└── dist/                # Built output
```

### Core Logger Features

```typescript
// Basic usage
import { logger } from "@aibos/logger";

logger.info("User logged in", { userId: "123", tenantId: "abc" });
logger.warn("Rate limit exceeded", { ip: "192.168.1.1", limit: 100 });
logger.error("Database connection failed", { error: err });

// With automatic context binding
import { logger } from "@aibos/logger/bind";
logger.info("Processing request"); // Automatically includes reqId, tenantId, etc.
```

### Request Context System

```typescript
// Middleware integration
import { withRequestContext } from "@aibos/utils/context";

export const withCtx = handler => async req => {
  const context = {
    reqId: req.headers.get("x-request-id") ?? randomUUID(),
    tenantId: req.headers.get("x-tenant-id"),
    userId: req.headers.get("x-user-id"),
    route: new URL(req.url).pathname,
  };

  return withRequestContext(context, () => handler(req));
};
```

### Secret Redaction

```typescript
// Automatically redacts sensitive data
const sensitiveData = {
  password: "secret123",
  apiKey: "sk-1234567890",
  authorization: "Bearer token123",
  supabaseKey: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
};

logger.info("API call", sensitiveData);
// Output: { "password": "[REDACTED]", "apiKey": "[REDACTED]", ... }
```

---

## Migration Strategy

### Approach: Gradual Replacement

1. **Keep existing logs** during transition
2. **Add structured logs** alongside console logs
3. **Remove console logs** after verification
4. **Maintain backward compatibility**

### Migration Priority Matrix

| Component       | Priority | Effort | Impact | Timeline |
| --------------- | -------- | ------ | ------ | -------- |
| API Routes      | Critical | Medium | High   | Day 1-2  |
| Error Handling  | Critical | Low    | High   | Day 1    |
| Monitoring      | High     | Medium | Medium | Day 2    |
| UI Components   | Medium   | High   | Medium | Day 3-4  |
| Background Jobs | Low      | Medium | Low    | Day 5    |

### Example Migration

**Before**:

```typescript
console.log(`Usage alert triggered: ${usagePercentage}% (threshold: ${thresholdPercentage}%)`);
```

**After**:

```typescript
logger.warn("Usage threshold exceeded", {
  event: "usage.thresholdExceeded",
  usagePercentage,
  thresholdPercentage,
  tenantId: context.tenantId,
});
```

---

## Risk Assessment & Mitigation

### Risks

| Risk                     | Probability | Impact | Mitigation                     |
| ------------------------ | ----------- | ------ | ------------------------------ |
| Performance degradation  | Low         | Medium | Pino is faster than console    |
| Log volume explosion     | Medium      | High   | Implement sampling & retention |
| Breaking changes         | Low         | High   | Gradual migration approach     |
| Team adoption resistance | Medium      | Medium | Training & documentation       |

### Mitigation Strategies

1. **Performance**: Benchmark before/after, use Pino's performance optimizations
2. **Volume**: Implement log sampling, retention policies, and level-based filtering
3. **Breaking Changes**: Maintain backward compatibility, gradual rollout
4. **Adoption**: Provide clear migration guide, examples, and training

---

## Success Metrics

### Technical Metrics

- [ ] Build success rate: 100% (from current ~95%)
- [ ] Log consistency: 100% structured logs
- [ ] Performance: <5ms logging overhead
- [ ] Security: 0 sensitive data leaks

### Operational Metrics

- [ ] Debug time: 50% reduction in issue resolution
- [ ] Log searchability: 90% improvement in log queries
- [ ] Error tracking: 100% error correlation
- [ ] Team productivity: 30% faster debugging

---

## Resource Requirements

### Development Team

- **Lead Developer**: 1 person, 5-7 days
- **DevOps Engineer**: 0.5 person, 2-3 days (for production setup)
- **QA Engineer**: 0.5 person, 1-2 days (for testing)

### Infrastructure

- **Log Aggregation**: Grafana Loki (free) or Datadog (paid)
- **Storage**: ~10GB/month for log retention
- **Monitoring**: Existing Grafana setup

---

## Approval Checklist

### Technical Review

- [ ] Architecture aligns with existing patterns
- [ ] Performance impact acceptable
- [ ] Security requirements met
- [ ] Scalability considerations addressed

### Business Review

- [ ] ROI justifies implementation effort
- [ ] Timeline acceptable for business needs
- [ ] Risk level acceptable
- [ ] Resource allocation approved

### Operational Review

- [ ] Production deployment plan approved
- [ ] Monitoring and alerting configured
- [ ] Rollback plan defined
- [ ] Team training scheduled

---

## Next Steps

1. **Review and approve** this plan
2. **Assign resources** and timeline
3. **Begin Phase 1** implementation
4. **Schedule regular checkpoints** for progress review

---

## Appendices

### A. Current Logging Inventory

**High Priority Files** (Build-breaking or critical paths):

- `apps/web-api/app/api/usage/route.ts` - 3 console statements
- `packages/ui/src/components/rules/RuleWorkflow.tsx` - 13 console statements
- `packages/monitoring/src/logger.ts` - 5 console statements

**Medium Priority Files** (API routes, error handling):

- `apps/web-api/app/api/*` - ~50 files with console statements
- `packages/utils/src/*` - ~20 files with console statements

**Low Priority Files** (UI components, utilities):

- `packages/ui/src/components/*` - ~100 files with console statements
- `scripts/*` - ~50 files with console statements

### B. Technology Stack

**Core Technologies**:

- Pino (logger) - Fast, JSON, production-ready
- AsyncLocalStorage (context) - Node.js built-in
- ESLint (enforcement) - Existing tooling
- TypeScript (types) - Existing tooling

**Integration Points**:

- Next.js App Router (middleware)
- React (error boundaries)
- Supabase (database operations)
- Existing monitoring infrastructure

### C. Compliance & Security

**Data Protection**:

- Automatic redaction of PII
- GDPR compliance for EU users
- SOC 2 compliance for enterprise

**Security**:

- No secrets in logs
- Audit trail for sensitive operations
- Rate limiting for log volume

---

**Document Version**: 1.0  
**Last Updated**: 2024-01-21  
**Next Review**: After Phase 1 completion  
**Approval Required**: Technical Lead, DevOps Lead, Product Owner
