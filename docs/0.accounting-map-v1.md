# AI‑BOS Accounting – Master Development Plan (Close‑the‑Gap)

## Mission & Outcomes
**Mission:** Close the back‑end ↔ front‑end integration gap and ship a production‑ready, tenant‑safe Accounting SaaS using a **Capability‑first → Contract‑led → Vertical‑slice** approach.

**Target outcomes (within 4–6 sprints):**
- Frontend routes coverage ≥ **90%** for core accounting (AR/AP/Close/Reports).
- Orphaned UI components reduced from ~95% → **<25%** (either integrated or retired).
- Contract test pass rate **≥ 99%**, property tests for double‑entry **100% pass**.
- P95 API latency **< 300 ms**, page TTI **< 2.5s** on mid‑tier hardware.
- CI quality gates green: type‑safe, lint‑clean, migrations validated, Spectral + Zod contract checks.

---

## Operating Principles
1. **Capability is the source of truth** (e.g., Issue Invoice, Receive Payment, Close Period).
2. **Contracts are the freeze line** (OpenAPI + Zod + Events). No UI or backend PR merges without updated contracts.
3. **Ship thin verticals** (DB → domain → use‑case → API → BFF → UI → tests).
4. **Invariants enforced in code + DB** (double‑entry=0, period gates, tenant isolation via RLS/Policies).
5. **Observability & audit are first‑class** (trace + audit trail + metrics per capability).

---

## Workstreams & Leads (RACI)
- **Domain/Business Logic** – *Owner:* Backend Lead. *R:* Domain models, state machines, invariants.
- **API/BFF** – *Owner:* Platform Lead. *R:* HTTP adapters, idempotency, error contracts (RFC7807), caching.
- **Frontend (Web)** – *Owner:* UI Lead. *R:* Pages, flows, accessibility, performance.
- **DB & RLS** – *Owner:* Data Lead. *R:* Schemas, constraints, RLS, migrations, indexes.
- **Security & Compliance** – *Owner:* SecOps. *R:* AuthN/Z, secrets, compliance endpoints, DR.
- **Observability** – *Owner:* SRE. *R:* Traces, logs, metrics, error budgets.
- **QA & Test Automation** – *Owner:* QA Lead. *R:* Unit/contract/property/E2E.
- **Docs & DevEx** – *Owner:* DX Lead. *R:* OpenAPI, typedocs, VitePress, scripts, PR templates.

---

## Phase 0 — Stabilization & Guardrails (Week 0)
**Goal:** Make drift impossible and failures obvious.

**Deliverables:**
- **Contracts package:** `packages/contracts`
  - Zod schemas per capability; codegen OpenAPI (publish to `/openapi.json`).
  - Spectral ruleset + CI step.
- **Error contracts:** RFC7807 problem+json everywhere (shared types in `@aibos/contracts`).
- **Idempotency:** middleware in BFF for all `POST/PUT/PATCH` (idempotency‑key header; safe retries).
- **RLS review:** tenant_id column presence, row‑level policies for read/write; unit tests for RLS.
- **Audit logs:** standard event for every mutation (who/when/what) + reason.
- **Clean‑up:** remove/flag `console.log`/TODO stubs; create `tech‑debt.md` register.
- **CI Quality Gates:** typecheck, eslint, test, migrations dry‑run, spectral, zod parse, bundle size, Lighthouse CI (key flows).

**Exit criteria:** All pipelines green; baseline OpenAPI published; >95% of `console.log` removed or guarded.

---

## Phases & Sprints (Vertical‑Slice Plan)

### Sprint 1 — **Accounts Receivable (AR) Core** (Week 1–2)
**Capabilities:** Issue Invoice → Approve → Post; Customers; Trial Balance (read).

**Scope:**
- DB: `invoices`, `invoice_lines`, `tax_lines`, FKs; `gl_entries` balanced constraint; period FK.
- Domain: `invoices.aggregate` (state machine), `postInvoice()` enforces zero‑sum journal.
- API: `/api/invoices` (CRUD + approve + post), `/api/customers`, `/api/reports/trial-balance`.
- UI: `/invoices` list/detail/new, `/customers` list/detail, `/reports/trial-balance`.
- Tests: property test (debit==credit), contract tests for endpoints, E2E flow (create→approve→post→TB delta).
- Observability: spans `invoice.post`, metrics per tenant, error budget SLO.

**Gate:** TB shows posted invoice; E2E green; a11y AA; performance budgets met.

---

### Sprint 2 — **Accounts Payable (AP) + Payments** (Week 3–4)
**Capabilities:** Bills (approve/post), Payments (receive/pay & apply), AR/AP Aging.

**Scope:**
- DB: `bills`, `bill_lines`, `payments`, `payment_applications`.
- Domain: `applyPayment()` with rounding/FX rules.
- API: `/api/bills`, `/api/payments`, `/api/reports/aging?type=AR|AP`.
- UI: `/bills`, `/payments`, `/reports/aging`.
- Tests: property tests for application sum, contract tests, E2E (bill→post→payment→aging).

**Gate:** Aging report matches ledger; partial/over/under‑payment covered.

---

### Sprint 3 — **Period Close & Export** (Week 5)
**Capabilities:** Open/Close/Reopen Periods; Export (MBRS/MyInvois stubs).

**Scope:**
- DB: `fiscal_periods` (status, lock timestamps) + constraints to block posting when closed.
- Domain: `closePeriod()` with checks; `journal locks`.
- API: `/api/periods` open/close; `/api/exports` (trial balance, P&L, BS, tax files (stub)).
- UI: `/admin/periods`, `/admin/exports`.
- Tests: ensure lock blocks posting; export file schema matches spec.

**Gate:** Locked periods enforce invariants; exports downloadable and validated.

---

### Sprint 4 — **Security, Monitoring, DR, Compliance UI** (Week 6)
**Capabilities:** Surface existing advanced back‑end routes with admin UI.

**Scope:**
- Wire UIs for: `/api/security/audit`, `/api/security/compliance`, `/api/security/disaster-recovery`, `/api/monitoring/dashboard`.
- RBAC surface: Finance vs Admin vs Auditor views.
- Add alerts/notifications (email/webhooks) for high‑risk events.

**Gate:** Admin can see audits, run DR checks, view compliance status, and receive alerts.

---

### Sprint 5 — **Performance, Accessibility & Orphaned UI Cleanup** (Week 7)
**Scope:**
- Integrate or retire orphaned components. Target <25% orphan rate.
- Perf: cache hot reads (customer lists, settings), add indexes, N+1 audits.
- A11y: WCAG 2.2 AA/AAA where feasible; keyboard flows.
- Docs: task‑oriented guides for AR/AP/Close.

**Gate:** Perf budgets hit; orphan rate reduced; doc tasks validated by QA.

---

## Capability Mapping Matrix (Template)
Use one row per capability; store in `docs/mapping/matrix.csv` (SSOT) and keep updated in PRs.

| Field | Example Fill |
|---|---|
| Capability | Issue Sales Invoice |
| States | draft → approved → posted → voided |
| Invariants | debit−credit=0; tax=base×rate; post only if period=open |
| API | POST /api/invoices; POST /api/invoices/{id}/approve; POST /api/invoices/{id}/post |
| Events | InvoiceCreated.v1; InvoiceApproved.v1; InvoicePosted.v1 |
| BFF/Adapters | apps/web-api/app/api/invoices/route.ts (create/approve/post) |
| Use‑cases | packages/accounting/src/invoices/post.ts |
| Domain | packages/accounting/src/invoices/aggregate.ts |
| DB | invoices, invoice_lines, tax_lines, gl_entries |
| RLS | tenant_id enforced; posted visibility per role |
| UI | /invoices/new, /invoices/[id], Post button |
| Validation | packages/contracts/src/invoices.ts (Zod + OpenAPI) |
| Tests | property: balance; E2E: issue→post→TB |
| Telemetry | span: invoice.post; attrs: tenant_id, invoice_id |

---

## Definition of Done (Per Capability)
- **Contracts:** OpenAPI & Zod checked‑in; Spectral passes; examples validated.
- **DB & Policies:** Migrations applied; FKs, unique, checks; RLS tests pass.
- **Domain & Use‑case:** Invariants coded; idempotency supported.
- **API:** Routes implemented; RFC7807 errors; pagination & filtering where needed.
- **UI:** Accessible screens and actions; error states; loading skeletons.
- **Tests:** unit + contract + property + E2E all green; coverage thresholds met.
- **Observability:** Traces/metrics/audit events emitted and visible.
- **Docs:** User guide + troubleshooting updated.

---

## CI/CD & Tooling
**Pipelines:**
- `checks`: typecheck, lint, unit, property, contract, E2E (smoke), spectral, zod parse.
- `db-migrate`: validate migrations in a scratch DB; run RLS tests.
- `contracts-publish`: build and publish `/openapi.json`; bump semver on changes.
- `perf-a11y`: Lighthouse CI on critical pages; Axe tests for a11y.

**PR Template (excerpt):**
```md
### Capability & Contracts
- [ ] Mapping Matrix row updated
- [ ] OpenAPI + Zod updated and validated

### Vertical Slice
- [ ] DB migrations + RLS
- [ ] Use‑case + API route
- [ ] UI flow screens

### Quality
- [ ] Unit/Contract/Property/E2E tests
- [ ] Traces/metrics added
- [ ] Docs updated
```

---

## Test Strategy
- **Unit:** Domain invariants, calculators (VAT, FX, rounding).
- **Property:** Journal entries always balance; payment applications never exceed balance; posting blocked when period closed.
- **Contract:** Dredd or Pact‑style vs OpenAPI; example payloads in CI.
- **E2E:** Playwright: AR happy path; AP happy path; Close & Export; Admin security pages.
- **RLS:** Intentional cross‑tenant attempts must fail; positive paths succeed.

---

## Security, Compliance & DR
- JWT verification with rotation; JWKS caching; clock skew tolerance.
- Per‑tenant encryption for sensitive fields (where applicable).
- Backups verified; DR drills scripted; export integrity checksums.
- Compliance dashboard wiring (surface existing routes + alerts/notifications).

---

## Risk Register & Mitigations
- **Frontend lag vs backend:** enforce contract freeze + vertical PR rule.
- **Schema churn:** migration RFC + feature flags; write compatibility shims; use views when needed.
- **Performance regressions:** budgets in CI; query plans reviewed; add indexes.
- **Windows doc build issues:** lock CI on Linux; dev notes include Windows workarounds.
- **Auth/JWT issues:** add test harness with real JWTs; fallback to local JWKS in CI.

---

## Metrics & SLIs/SLOs
- **Coverage:** route/page coverage %, orphaned UI %, contract test pass %.
- **Reliability:** error rate <1%, idempotent retry success %, DR drill success.
- **Performance:** P95 latency per endpoint; DB query P95; client TTI.
- **Security:** RLS test pass %, least‑privilege checks, token verification failure ratio.

---

## Backlog to Close Gaps (Top Items)
1. Create `@aibos/contracts` with Zod + OpenAPI + Spectral rules.
2. Implement idempotency middleware in BFF and wire to all mutating endpoints.
3. Build `/invoices`, `/customers`, `/reports/trial-balance` pages (Sprint 1).
4. Wire `/api/security/*` and `/api/monitoring/*` to Admin UI (Sprint 4).
5. Property tests for journals, payments; RLS tests.
6. Remove or integrate 50% of orphaned UI components by Sprint 5.

---

## Rollout Plan
- **Dev/Staging tenants** with seeded data; masked prod snapshots for perf testing.
- **Feature flags** for new flows (e.g., Posting v2); staged rollouts.
- **Release cadence:** end‑of‑sprint tagged releases; change logs scoped by capability.

---

## Appendix A — Suggested Repo Paths
- `apps/web` – Next.js UI (App Router) pages: invoices, customers, bills, payments, reports, admin/*
- `apps/web-api` – BFF/API routes per capability; idempotency & auth middleware
- `packages/accounting` – domain models, state machines, use‑cases
- `packages/contracts` – Zod schemas, OpenAPI emit, examples
- `packages/ui` – shared components (trim, integrate, or retire)
- `packages/utils` – api client, state hooks, telemetry helpers
- `supabase/migrations` (or `packages/db/migrations`) – SQL/Drizzle migrations, RLS tests
- `docs/` – capability guides, mapping matrix SSOT

---

## Appendix B — Example Capability Spec (Issue & Post Invoice)
**Goal:** Convert an approved invoice to journal entries and update AR.

**Actors:** Sales Ops (create), Finance (approve/post).

**Pre‑conditions:** Customer exists; period=open; invoice=approved; lines valid.

**Post‑conditions:** Balanced `gl_entries`; AR updated; `InvoicePosted.v1` emitted; audit logged.

**Edge cases:** FX rounding, partial lines, voided invoice, closed period.

**Acceptance Criteria:**
- Posting fails gracefully if period closed; meaningful RFC7807 details.
- Trial Balance reflects the posting immediately.
- Idempotent: re‑sending the same request returns 2xx without duplicate journals.

